### 国密

国家商用密码，简称商密，拼音缩写时SM。

为什么要使用国密？发展自己的加密算法，比使用美国公布的加密算法安全，防止数学后门；摆脱国外技术控制的必然举措；提升标准国际话语权必要举措。

SM1 和 SM4 是对称算法，对标 AES；

SM2 是非对称算法，对标 RSA、ECDSA；可以用作签名

SM3 是摘要算法，对标 MD5；

国密SDK：郑州信大捷安信息技术股份有限公司 www.xdja.com

### No.2 

##### 常见的安全威胁

信息安全事故：

CSDN的600万用户数据被泄露：脱裤

需要落实国家信息安全等级保护制度

弱密码：123456

##### 信息安全介绍

基本原则

- 机密性
- 完整性
- 可用性
- 不可否认性

##### 基础知识温习

```
1 byte = 8 bit
1 int = 4 byte = 32 bit = 1 word
1 long = 8 byte = 64 bit = 2 word
1 short/char = 2 byte = 16 bit
```

##### 不可靠通信模型和术语

可能被窃听

可能被篡改

可能有损传输

明文：Plain Text

密文：Cipher Text

密钥：Key

加密：Encrypt

解密：Decrypt

编码：Encode

解码：Decode

##### 古典密码--移位密码和维吉尼亚密码

### No.3 

##### 无处不在的Hash应用

校验文件是否完整

##### 介绍Hash函数和性质

一个函数 H(x) = y 被称为 Hash 函数

随机性、单向性、有效性

常见的 Hash 方法：md5 sha1 sha256 SM3(国密)

##### 密码学Hash的安全性

- 原像困难

  给定 h(x) = y 计算出 x 是困难的

- 第二原像困难

  对任意消息 x 找出另一个消息 x 满足 h(x) =h(x') 是困难的

- 碰撞困难

  要找出两个随机的消息 x 和 x' 使得 h(x) = h(x') 是困难的

##### 详解MD5 SHA1原理

MD5

- 摘要长度 128 bit
- 块大小 512 bit
- 轮计算 4

MD5/SHA1步骤

- 预处理
- 四轮函数

##### Hash计算的一般过程

1. 消息填充和预处理
2. 分块处理
3. 迭代 Hash 函数计算
4. 最终计算，输出摘要值

##### 实战应用-库和硬件支持

OpenSSL 基础库

- 行业基础库
- 开发语言实现

##### 实战应用-openssl等工具演示

OpenSSL 项目、命令

- Libcrypto 密码算法、证书
- Libsll SSL 连接

```shell
# 查看版本
openssl version -a
# 查看摘要算法
openssl list -digest-commands
# 使用 sha256 计算文件 hash 值
openssl dgst -sha256 file...
# 获取网络流进行 sha1 计算
curl -s https://www.baidu.com/licence/ | openssl dgst -sha1
```

#####  实战应用-Hash在Redis中的应用

Redis keyHashSlot 方法使用 hash 计算确定键值分布

##### 实战应用-Hash在比特币中的应用

PoW 机制伪代码：

Sha256(上一个Hash值，其他信息，随机数) < 目标值

##### 实战应用-Hash在Git中的应用

每一次 commit 的 commit id 都有唯一标识

##### 从java.security学习MessageDigest

```java
MessageDigest md = MessageDigest.getInstance("md5");
```

##### 典型Hash应用

- 单向口令文件

  linux 如何保存用户密码

- 一致性校验

- 伪随机数发生器

- 数字货币

#####  安全性问题

hash 碰撞一定存在

禁止 MD5 用在数字安全领域；SHA-1已经被事实上放弃。使用SHA256。

### No.4

##### 回顾古典密码-介绍对称加密

移位密码

AES、DES

目前推荐使用只有：AES

##### 介绍AES

迭代型密码，分组长度128bit，密钥128/192/256bit，轮数10/12/14

##### AES的轮计算细节

1. 按字节值初始化S盒
2. 把S盒每个字节映射为GF有限域上的逆
3. 把S盒每个字节做防射变换
4. 字节替换：查表替换
5. 行移位变换
6. 列混淆变换
7. 轮密钥加

##### AES密钥扩展细节

##### 实战应用-库和硬件支持

ARM v8/AArch64

```shell
sysctl -a machdep.cpu
```

##### 实战应用-生活中的AES

- 证书/网络

##### 实战应用-Openssl应用

```shell
# 查看支持哪些对称加密
openssl list -cipher-commands
# 文本消息AES128加密，指定密钥16byte 128bit
echo 'hello,world' | openssl enc -aes-128-ecb -K 000102030405060708090a0b0c0d0e0f -base64
# 解密
echo 'dUdZJ7DQE8UjuvXfuoguKQ==' | openssl enc -d -aes-128-ecb -K 000102030405060708090a0b0c0d0e0f -base64
# 文件加密
openssl enc -aes-128-ecb -K 000102030405060708090a0b0c0d0e0f -base64 -in INPUT_FILE -out OUTPUT-FILE
# 16进制查看文件
xxd file
```

##### 从java.security学习Cipher

- 密钥生成
  - KeyGenerator.getInstance("AES")
  - keyGenerator.init(keyLen)
  - keyGenerator.generateKey()

- 密钥导入
  - SecretKeySpec(xxx, "AES")
- 密码器
  - Cipher.getInstance("AES")
  - cipher.init()
  - cipher.update()
  - cipher.doFinal()

### No.5

##### 分组密码的概念

分组密码又称分块加密或块密码

- 它将明文分成多个等长的块 block
- 使用确定的算法和密钥对每组分别加密解密

与之对应的是流密码

- 加密解密可以接受不定长的明文输入
- 第一章古典密码

分组密码遇到的问题

- 如何使用不定长度的密钥
- 如何处理不定长度的输入报文
- 如何避免风险

##### 初始化向量和填充方式

分组密码的工作模式

工作模式，设计一系列流程，关于密钥、随机量、明文、密文的操作顺序等问题的抽象泛化解决方案。

初始化向量IV，是引入随机化变量的一种措施。有些场景称为Nonce

- 通常IV无须保密
- 但不可重用

某些工作模式下需要对输入进行填充补齐

##### 电子密码本ECB

足够简单，利于并行计算，误差不会放大；

不能隐藏明文特点，缺少完整性保护，重放安全风险；

##### 块链接CBC

##### 密文反馈CFB

##### 输出反馈OFB

##### 计数器CTR

##### 伽罗瓦计数GCM

##### 6种模式的比较总结

##### 实战应用 – 硬件支持和日常场景

##### 实战应用 - Openssl应用

##### 从java.security学习Cipher

CBC、CFB、OFB、CTR 模式逻辑演示

密钥

- 密钥生成

  KeyGenerator.getInstance(xxx)

- 密钥导入

  SecreKeySpec

密码参数

- IvParameterSepc
- GCMParameterSpec

密码器

- Cipher.getInstance(xxx)
- cipher.init()
- cipher.updateAAD()
- cipher.update()
- cipher.doFinal()

其他

- 工作模式
- 填充模式

### No.6 非对称加密

##### 非对称加密机制

##### 详解 RSA 加解密过程

##### 详解 RSA 密钥生成

##### RSA 安全性浅析

- 逆计算不可行
- 破解密钥很困难

##### 详解椭圆曲线ECC加解密

- 椭圆曲线密码学：是一种基于椭圆曲线数学的公开密钥加密算法
- ECC的主要优势是它相比RSA加密算法使用较小的密钥长度并提供相当等级的安全性
- 椭圆曲线密码学的算法是在2004年至2005年开始广泛应用

##### ECC安全性浅析

##### 实战应用-Openssl应用讲解

```shell
# 生成RSA密钥写入文件保存
openssl genrsa -out key.pem 1024
# 私钥导出公钥
openssl rsa -in key.pem -pubout -out pubkey.pem
# 公钥加密文件
openssl rsautl -encrypt -in file1 -inkey pubkey.pem -pubin -out file2
# 私钥解密文件
openssl rsautl -decrypt -in file2 -inkey key.pem
```

##### 从java.security学习Cipher

##### 非对称加密

### No.7 数字签名与消息完整性

##### 数据签名与消息完整性

##### 消息认证码和Hmac

可能存在的攻击分析

消息认证码

- 消息认证码，又称密码校验或者MAC
- 利用密钥生成一个固定长度的短数据，附加在原消息之后

基于Hash的消息认证码HMAC

##### HMac的应用场景案列

##### 从java.security学习 HMac

##### 介绍数字签名

消息认证可以保护信息交换双方不受第三方的攻击，但是它不能处理通信双方自身发生的攻击

- 必须能验证签名者，签名日期和时间
- 必须能认证被签的消息内容
- 签名可以由第三方仲裁，以解决争执

因此，数字签名具有认证功能

直接数字签名

##### RSA签名

##### ECDSA签名

##### 实战应用-数字签名应用场景

权威证明

- 发布者身份
- 对话身份
- 版权许可

##### 实战应用-OpenSSL应用

```shell
openssl genrsa -out rsa-key.pem 1024
openssl rsa -pubout -in rsa-key.pem -out rsa-pub.pem
# 加签
openssl dgst -sha256 -sign rsa-pub.pem -out file.sig1 file
# 验签
openssl dgst -sha256 -verify rsa-pub.pem -signature file.sig1 file
```

#####  从java.security学习 Signature

##### 数字签名与消息完整性

### No.8 密钥交换和数字信任链

##### 密钥交换和数字信任链

Key Exchange & Chain of Trust

##### Diffie-Hellman 密钥交换

DH算法是一种匿名密钥协商方案

##### ECDH 密钥交换

椭圆曲线密钥交换协议

##### 从java.crypto学习 DH

##### 数字信任-公钥基础设施

公钥分发方案：

1. 公开发布，有公开服务商

2. 公钥授权，需要组织登记查询；公钥授权中心

3. 公钥证书：使用证书来交换公钥，而不是管理员

   证书包含公钥，所有者标志，可信第三方签名

公钥基础设施 PKI

X.509 证书

##### 实战应用-操作系统的信任链

##### 实战应用-Openssl应用讲解

pem 格式证书转换成 der 格式证书

```shell
openssl x509 -in ca.pem -inform pem -out ca.der -outform der
```

导入CA到cacerts

指定新的 trustStore

##### 实战应用-java中的信任链

```shell
# 生成密钥
openssl genrsa -out domain.key 2048
# 生成CSR文件，可以交给签名机构签名证书
openssl req -new -key domain.key -out domain.csr
# 开始自签名创建CA
# 生成CA私钥
openssl genrsa -out ca.key 2048
# 生成自签名证书
openssl req -new -x509 -sha256 -days 30 -key ca.key -out ca.crt
# 签署证书
openssl x509 -req -CA ca.crt -CAKey ca.key -in domain.csr -out domain.crt -days 30 -CAcreateserial
```

##### 密钥交换和数字信任链

### No.9 编码与解码

##### 详解Hex编码

##### 详解Base64编码

减少I/O开销

##### 学习Unicode字符集

##### 学习字符集编码

#####  Java 与 Unicode

##### 编程与解码

### No.10 协议分析

##### 学习 HTTPS 协议

HTTPS 协议 超文本传输安全协议

HTTPS = HTTP + SSL/TLS

##### 实战分析 HTTPS TLS 协议

WIRESHARK 网络协议分析器

```shell
curl -v --tlsv1.2 --http1.1 https://110.alipay.com
```

##### 学习 SSH 协议

##### 实战分析 SSH 协议

##### 安全通信的设计要素

1. 目标身份：通信双方确认身份
2. 协商密钥
3. 对称加密
4. 消息完整性

### No.11 综合应用案例

##### 密码存储与验证

##### 密钥口令的配置分发

##### 接口设计中的身份认证和消息认证

##### 敏感数据安全方案

##### 自签名证书的相关问题

##### 软件许可证机制的讨论

##### 自研通信协议的相关问题

- 私有的非标准化协议
- 自定义数据安全方案
- 追求高性能或其他特性

### No.12 扩展和总结

#####  Java安全体系设计 JCA JCE

##### 通用安全模块的设计

常见的结构化请求数据的加签

排序器 连接器 加签密码器 编码器

```java
Map<String, Object> params = new HashMap<>();
String hash = StructHashing.<String, Object>of("md5")
  .withSorter(sorter)
  .withJoiner(joiner)
  .withEncoder(encoder)
  .digest(params);
```

##### 生存 - 正确的使用

##### 进阶 - 驾轻就熟有深度

##### 以密码学为武器，实践信息安全

